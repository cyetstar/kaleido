import{_ as te,G as ae,u as le,a as p,x as Z,ag as ne,v as ue,b as m,o as r,l as P,w as o,g as S,f as e,k as t,t as R,z as F,e as i,N as H,P as Q,ah as re,ai as ie,aj as ce,c as b,F as M,a9 as me,n as W,a2 as z,y as pe,ak as de,a4 as ve,aa as _e}from"./index-8V0LDlr9.js";import{b as oe,c as fe,d as he,_ as be}from"./comicSeriesFileManage-joA7-t-O.js";import{R as ge,a as se,S as B,i as ke,b as ye}from"./image-compressor-mN1qqc4Y.js";import{M as Ce}from"./MinusOutlined-ga10JiA-.js";import{_ as xe}from"./comicSeriesSearchInfo-zXohGcel.js";const Se={class:"flex"},we={class:"ml-3"},Le=["src"],Ue={class:"mt-4"},Be={class:"mt-4"},Ie={__name:"comicSeriesSetCover",setup(Y,{expose:K}){ae(),le();let L=p(),s=p(1),g=p([]),_=p([]),d=p(),a=p(0),k=p(),y=p(0),f=p({}),T=Z(()=>{let n=ne("imageUrl");return n=n+"page?id="+f.value.id+"&number="+s.value,n}),I=p(!0),D=ue(),x=!1,l=p(0);const U=()=>{g.value=[];for(let n=1;n<=f.value.pageCount;n++)g.value.push({text:n,value:n})},C=()=>{se({pageSize:2e3,orderBy:"ASC:book_number",seriesId:f.value.seriesId}).then(n=>{_.value=n.records.map(c=>({text:c.bookNumber,value:c.id,className:c.coverPageNumber!=null?"cover":"",...c})),a.value=n.records.length,y.value=n.records.findIndex(c=>c.id===k.value),U()})},X=n=>{f.value=n,k.value=n.id,s.value=1,L.value=!0,C()},V=n=>{y.value=_.value.findIndex(c=>c.value===k.value),f.value=_.value.filter(c=>c.value===n.id)[0],f.value.pageCount<s.value&&(s.value=f.value.pageCount),U()},w=n=>{B&&B.rotate(n)},$=()=>{if(!B)return;let n=I.value?D.$state.cropBoxData:JSON.parse(f.value.coverBoxData)||D.$state.cropBoxData;n&&B.setCropBoxData(n),d.value=B.getDataURL(),x=!0},J=()=>{B&&(d.value=B.getDataURL())},j=()=>{if(I.value=!I.value,!B)return;let n=I.value?D.$state.cropBoxData:JSON.parse(f.value.coverBoxData)||D.$state.cropBoxData;n&&B.setCropBoxData(n)},E=()=>{O().then(n=>{n&&(k.value=_.value[y.value+1].value,V({id:k.value}))})},u=()=>{l.value>0?(clearInterval(l.value),l.value=0):l.value=setInterval(()=>{x&&(a.value>y.value+1?E():(A(),clearInterval(l.value),l.value=0),x=!1)},500)},A=()=>{O().then(n=>{L.value=!n})},O=()=>{if(!B)return;let n=B.getDataURL(),c=B.getCropBoxData();const q=new ke.ImageCompressor,G={toWidth:300,mimeType:"image/jpg",mode:"strict",speed:"low"};return new Promise(N=>{q.run(n,G,v=>{ye({...f.value,data:v,coverPageNumber:s.value,coverBoxData:JSON.stringify(c)}).then(h=>{if(h){let ee=B.getCropBoxData();D.setCropBoxData(ee),Q.success("设置成功")}else Q.error("设置失败");return N(h)})})})};return K({show:X}),(n,c)=>{const q=m("h-module-title"),G=m("h-radio"),N=m("h-button"),v=m("a-modal");return r(),P(v,{ref:"formRef",visible:t(L),"onUpdate:visible":c[4]||(c[4]=h=>H(L)?L.value=h:L=h),title:"设置封面页",width:"1200px",style:{top:"20px"}},{footer:o(()=>[e(N,{type:"default",onClick:c[2]||(c[2]=h=>w(90))},{default:o(()=>[S("顺时针旋转")]),_:1}),e(N,{type:"default",onClick:c[3]||(c[3]=h=>w(-90))},{default:o(()=>[S("逆时针旋转")]),_:1}),e(N,{type:"default",onClick:j},{default:o(()=>[S(R(t(I)?"上次比例":"原先比例"),1)]),_:1}),e(N,{type:"primary",onClick:O},{default:o(()=>[S("确认")]),_:1}),t(a)>t(y)+1?(r(),P(N,{key:0,type:t(l)>0?"default":"primary",class:"ml-3",onClick:u},{default:o(()=>[S(R(t(l)>0?"关闭处理":"自动处理"),1)]),_:1},8,["type"])):F("",!0),t(a)>t(y)+1?(r(),P(N,{key:1,type:"primary",class:"ml-3",onClick:E},{default:o(()=>[S("确认并下卷 ")]),_:1})):(r(),P(N,{key:2,type:"primary",class:"ml-3",onClick:A},{default:o(()=>[S("确认并关闭 ")]),_:1}))]),default:o(()=>[i("div",Se,[i("div",null,[e(t(ge),{boxStyle:{width:"800px",height:"300px",backgroundColor:"#f8f8f8",margin:"auto"},img:t(T),options:{viewMode:1,zoomable:!1,dragMode:"crop",initialAspectRatio:21/29.7},onReady:$,onCropend:J},null,8,["img"])]),i("div",we,[i("img",{src:t(d),class:"",style:{"object-fit":"contain",height:"300px"}},null,8,Le)])]),e(q,{title:"单卷",class:"mt-4"}),i("div",Ue,[e(G,{button:"",columns:t(_),value:t(k),"onUpdate:value":c[0]||(c[0]=h=>H(k)?k.value=h:k=h),onChange:V},null,8,["columns","value"])]),e(q,{title:"页码",class:"mt-4"}),i("div",Be,[e(G,{button:"",columns:t(g),value:t(s),"onUpdate:value":c[1]||(c[1]=h=>H(s)?s.value=h:s=h)},null,8,["columns","value"])])]),_:1},8,["visible"])}}},De=te(Ie,[["__scopeId","data-v-e772cb0c"]]),Te={__name:"authorForm",emits:["save-complete"],setup(Y,{expose:K,emit:L}){const s=L;let g=p("create"),_=p(),d=p({id:"",name:""});const a=()=>{g.value="create",_.value.reset(),_.value.show()},k=async f=>{g.value="update",_.value.reset(),d.value=await re({id:f}),_.value.show()},y=async()=>{try{g.value==="create"?await ie(d.value)&&(Q.success("操作成功"),s("save-complete"),_.value.hide()):g.value==="update"&&await ce(d.value)&&(Q.success("操作成功"),s("save-complete"),_.value.hide())}catch{}};return K({create:a,update:k}),(f,T)=>{const I=m("h-input"),D=m("h-col"),x=m("h-form-modal");return r(),P(x,{ref_key:"formRef",ref:_,"label-col":{span:4},width:"600px",form:t(d),"onUpdate:form":T[1]||(T[1]=l=>H(d)?d.value=l:d=l),title:"漫画作者",onSubmit:y},{default:o(()=>[e(D,{span:24},{default:o(()=>[e(I,{label:"姓名",value:t(d).name,"onUpdate:value":T[0]||(T[0]=l=>t(d).name=l),name:"name"},null,8,["value"])]),_:1})]),_:1},8,["form"])}}},Ae={__name:"comicSeriesForm",emits:["save-complete"],setup(Y,{expose:K,emit:L}){const s=L;let g=p(),_=p("create"),d=p(),a=p({id:"",title:"",summary:"",publisher:"",bookCount:"",rating:"",status:"",bgmId:""}),k=p("basic");const y=()=>{_.value="create",d.value.reset(),d.value.show()},f=async x=>{_.value="update",d.value.reset(),a.value=await oe({id:x}),a.value.writerList.length>0&&(a.value.writerList=a.value.writerList.map(l=>l.id)),a.value.pencillerList.length>0&&(a.value.pencillerList=a.value.pencillerList.map(l=>l.id)),a.value.alternateTitleList.length===0&&a.value.alternateTitleList.push(""),d.value.show()},T=x=>{x===0?a.value.alternateTitleList.push(""):a.value.alternateTitleList.splice(x,1)},I=()=>{g.value.create()},D=async()=>{try{_.value==="create"?await fe(a.value)&&(Q.success("操作成功"),s("save-complete"),d.value.hide()):_.value==="update"&&(a.value.alternateTitleList=a.value.alternateTitleList.filter(l=>l!==""),await he(a.value)&&(Q.success("操作成功"),s("save-complete"),d.value.hide()))}catch{}};return K({create:y,update:f}),(x,l)=>{const U=m("h-input"),C=m("h-col"),X=m("h-radio"),V=m("a-tab-pane"),w=m("k-select-author"),$=m("h-select"),J=m("a-tabs"),j=m("a-col"),E=m("h-form-modal");return r(),b(M,null,[e(E,{ref_key:"formRef",ref:d,"label-col":{span:4},width:"1000px",form:t(a),"onUpdate:form":l[12]||(l[12]=u=>H(a)?a.value=u:a=u),title:"漫画系列",onSubmit:D},{default:o(()=>[e(j,{span:24},{default:o(()=>[e(J,{activeKey:t(k),"onUpdate:activeKey":l[11]||(l[11]=u=>H(k)?k.value=u:k=u),"tab-position":"left"},{default:o(()=>[e(V,{key:"basic",tab:"基本"},{default:o(()=>[e(C,{span:24},{default:o(()=>[e(U,{label:"标题",value:t(a).title,"onUpdate:value":l[0]||(l[0]=u=>t(a).title=u),name:"title"},null,8,["value"])]),_:1}),e(C,{span:24},{default:o(()=>[e(U,{label:"原标题",value:t(a).originalTitle,"onUpdate:value":l[1]||(l[1]=u=>t(a).originalTitle=u),name:"originalTitle"},null,8,["value"])]),_:1}),e(C,{span:24},{default:o(()=>[e(U,{label:"简介","text-area":"",rows:"4",value:t(a).summary,"onUpdate:value":l[2]||(l[2]=u=>t(a).summary=u),name:"summary"},null,8,["value"])]),_:1}),e(C,{span:24},{default:o(()=>[e(U,{label:"出版社",value:t(a).publisher,"onUpdate:value":l[3]||(l[3]=u=>t(a).publisher=u),name:"publisher"},null,8,["value"])]),_:1}),e(C,{span:24},{default:o(()=>[e(U,{label:"卷数",value:t(a).bookCount,"onUpdate:value":l[4]||(l[4]=u=>t(a).bookCount=u),name:"bookCount"},null,8,["value"])]),_:1}),e(C,{span:24},{default:o(()=>[e(U,{label:"评分",value:t(a).rating,"onUpdate:value":l[5]||(l[5]=u=>t(a).rating=u),name:"rating"},null,8,["value"])]),_:1}),e(C,{span:24},{default:o(()=>[e(X,{label:"完结状态",value:t(a).status,"onUpdate:value":l[6]||(l[6]=u=>t(a).status=u),"dict-type":"wjzt",name:"status"},null,8,["value"])]),_:1}),e(C,{span:24},{default:o(()=>[e(U,{label:"番组计划编号",value:t(a).bgmId,"onUpdate:value":l[7]||(l[7]=u=>t(a).bgmId=u),name:"bgmId"},null,8,["value"])]),_:1})]),_:1}),e(V,{key:"authors",tab:"作者"},{default:o(()=>[e(C,{span:24},{default:o(()=>[e(w,{value:t(a).writerList,"onUpdate:value":l[8]||(l[8]=u=>t(a).writerList=u),mode:"multiple",name:"writerList",label:"作者"},null,8,["value"])]),_:1}),e(C,{span:24},{default:o(()=>[e(w,{value:t(a).pencillerList,"onUpdate:value":l[9]||(l[9]=u=>t(a).pencillerList=u),mode:"multiple",name:"pencillerList",label:"作画"},null,8,["value"])]),_:1}),e(C,{span:24,offset:"4"},{default:o(()=>[S("找不到？"),i("a",{onClick:I},"新增作者")]),_:1})]),_:1}),e(V,{key:"tags",tab:"标签"},{default:o(()=>[e(C,{span:24},{default:o(()=>[e($,{mode:"tags",label:"标签",value:t(a).tagList,"onUpdate:value":l[10]||(l[10]=u=>t(a).tagList=u),name:"tagList"},null,8,["value"])]),_:1})]),_:1}),e(V,{key:"akas",tab:"别名"},{default:o(()=>[e(C,{span:24},{default:o(()=>[(r(!0),b(M,null,W(t(a).alternateTitleList,(u,A)=>(r(),P(U,{key:A,label:"别名",value:t(a).alternateTitleList[A],"onUpdate:value":O=>t(a).alternateTitleList[A]=O,name:"alternateTitle"+A,search:"",onSearch:O=>T(A),allowClear:!1},{enterButton:o(()=>[A===0?(r(),P(t(me),{key:0})):(r(),P(t(Ce),{key:1}))]),_:2},1032,["value","onUpdate:value","name","onSearch"]))),128))]),_:1})]),_:1})]),_:1},8,["activeKey"])]),_:1})]),_:1},8,["form"]),e(Te,{ref_key:"refAuthorForm",ref:g},null,512)],64)}}},Ne=te(Ae,[["__scopeId","data-v-2d51806a"]]),Re={class:"k-view-section"},$e={class:"flex"},Fe={class:"flex-1 ml-8"},Me={class:"flex items-center"},Pe={key:0,class:"mr-2"},Ve={key:0},Oe={key:1,class:"flex"},je=i("span",{class:"mr-2"},"作者:",-1),ze={class:"flex-1"},Ke={key:0,class:"px-2"},Ee=["onClick"],Je={key:2,class:"flex"},qe=i("span",{class:"mr-2"},"出版社:",-1),Ge={class:"flex-1"},We={key:3,class:"flex"},He=i("span",{class:"mr-2"},"又名:",-1),Qe={class:"flex-1"},Xe={key:0,class:"px-2"},Ye={class:"flex"},Ze=i("span",{class:"mr-2"},"总卷数:",-1),et={class:"flex-1"},tt={key:0},at={class:"flex"},lt=i("span",{class:"mr-2"},"更新于:",-1),ot={class:"flex-1"},st={key:0},nt={class:"grid grid-cols-24 gap-6"},ut={class:"absolute top-0 left-0 m-2px"},dt={__name:"comicSeriesView",setup(Y){const K=ae(),L=le(),s=p({}),g=p([]),_=p(),d=p(),a=p(),k=p(),y=K.query.id,f=Z(()=>s.value.rating/2),T=Z(()=>z(s.value.summary)?s.value.summary.split(`
`):null),I=p({id:y,seriesId:y,force:!0}),D=async()=>{oe({id:y}).then(w=>{s.value=w,se({pageSize:1e3,orderBy:"ASC:sort_number;ASC:book_number",seriesId:y}).then(({records:$})=>{g.value=$})})},x=w=>{L.push({path:"/comic/comicBook/view",query:{id:w}})},l=w=>{L.push({name:"comicSeriesPage",params:{keyword:w.name,load:"true"}})},U=()=>{d.value.show(y)},C=()=>{let w=g.value[0];_.value.show(w)},X=()=>{a.value.show(s.value)},V=()=>{k.value.update(y)};return pe(()=>{D()}),(w,$)=>{const J=m("a-tag"),j=m("h-button"),E=m("k-action-button"),u=m("a-space"),A=m("a-page-header"),O=m("k-thumb-image"),n=m("a-rate"),c=m("k-logo-link"),q=m("h-module-title"),G=m("a-card-meta"),N=m("a-card");return r(),b(M,null,[i("section",Re,[e(A,{title:s.value.title,onBack:$[0]||($[0]=()=>w.$router.go(-1))},de({backIcon:o(()=>[e(t(ve))]),extra:o(()=>[e(u,null,{default:o(()=>[e(j,{onClick:C},{default:o(()=>[S("设置封面")]),_:1}),e(E,{action:"comicSync","ok-text":"同步Komga","cancel-text":"取消同步",form:I.value},null,8,["form"]),e(E,{action:"comicMatchInfo","ok-text":"自动抓取","cancel-text":"取消抓取",form:I.value},null,8,["form"]),e(j,{onClick:X},{default:o(()=>[S("匹配抓取")]),_:1}),e(j,{onClick:V},{default:o(()=>[S("编辑")]),_:1}),e(j,{onClick:U},{default:o(()=>[S("文件管理")]),_:1})]),_:1})]),_:2},[s.value.status==="ENDED"?{name:"subTitle",fn:o(()=>[e(J,{color:"green"},{default:o(()=>[S("已完结 ")]),_:1})]),key:"0"}:void 0]),1032,["title"]),i("section",$e,[i("div",null,[e(O,{class:"h-poster",style:{width:"250px"},type:"ComicSeries",id:s.value.id},null,8,["id"])]),i("div",Fe,[i("p",Me,[t(z)(s.value.rating)?(r(),b("span",Pe,R(s.value.rating)+" 分",1)):F("",!0),e(n,{value:f.value,"onUpdate:value":$[1]||($[1]=v=>f.value=v),disabled:"","allow-half":""},null,8,["value"])]),i("p",null,[(r(!0),b(M,null,W(s.value.tagList,v=>(r(),P(J,{key:v},{default:o(()=>[S(R(v),1)]),_:2},1024))),128))]),t(z)(T.value)?(r(),b("p",Ve,[(r(!0),b(M,null,W(T.value,(v,h)=>(r(),b("p",{key:h},R(v),1))),128))])):F("",!0),t(z)(s.value.authorList)?(r(),b("p",Oe,[je,i("span",ze,[(r(!0),b(M,null,W(s.value.authorList,(v,h)=>(r(),b(M,null,[h!==0?(r(),b("span",Ke,"/")):F("",!0),i("a",{onClick:ee=>l(v)},R(v.name),9,Ee)],64))),256))])])):F("",!0),t(z)(s.value.publisher)?(r(),b("p",Je,[qe,i("span",Ge,R(s.value.publisher),1)])):F("",!0),t(z)(s.value.alternateTitleList)?(r(),b("p",We,[He,i("span",Qe,[(r(!0),b(M,null,W(s.value.alternateTitleList,(v,h)=>(r(),b(M,null,[h!==0?(r(),b("span",Xe,"/")):F("",!0),S(" "+R(v),1)],64))),256))])])):F("",!0),i("p",Ye,[Ze,i("span",et,[S(R(s.value.bookCount)+" ",1),t(z)(g.value)&&g.value.length!==s.value.bookCount?(r(),b("span",tt," ("+R(g.value.length)+") ",1)):F("",!0)])]),i("p",at,[lt,i("span",ot,R(t(_e)(s.value.updatedAt)),1)]),i("p",null,[e(c,{type:"komga",sub:"series",id:s.value.id,class:"mr-3"},null,8,["id"]),e(c,{type:"bgm",id:s.value.bgmId,class:"mr-3"},null,8,["id"])])])]),t(z)(g.value)?(r(),b("section",st,[e(q,{title:"单卷"}),i("div",nt,[(r(!0),b(M,null,W(g.value,v=>(r(),P(N,{key:v.id,class:"k-card col-span-3",bordered:!1},{cover:o(()=>[e(O,{class:"h-poster",type:"ComicBook",preview:!1,id:v.id,onClick:h=>x(v.id)},null,8,["id","onClick"]),i("div",ut,[e(c,{type:"komga",sub:"book",id:v.id,width:20,class:"mr-1"},null,8,["id"]),e(c,{type:"bgm",id:v.bgmId,width:20},null,8,["id"])])]),default:o(()=>[e(G,{title:v.title},null,8,["title"])]),_:2},1024))),128))])])):F("",!0)]),e(be,{ref_key:"refComicSeriesFileManage",ref:d},null,512),e(De,{ref_key:"refComicSeriesSetCover",ref:_},null,512),e(Ne,{ref_key:"refComicSeriesForm",ref:k,onSaveComplete:D},null,512),e(xe,{ref_key:"refComicSeriesSearchInfo",ref:a},null,512)],64)}}};export{dt as default};
